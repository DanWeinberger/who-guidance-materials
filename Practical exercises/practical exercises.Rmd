---
title: DRAFT:Measuring the impact of new vaccines using mortality and administrative hospitalization
  data
subtitle: Pneumococcal conjugate vaccine as a case study
output:
  rmdformats::readthedown:
    code_folding: hide
    self_contained: true
    thumbnails: false
    lightbox: false
    css: stylesreadthedown.css
    toc_depth: '3'
--- 

```{r setup, include=FALSE}
#https://bookdown.org/yihui/rmarkdown/html-document.html#table-of-contents
knitr::opts_chunk$set(echo = TRUE)
library(rmdformats)
```

Load the libraries we need for this exercise. If you get an error saying "error in library(): there is no package called..." this means you first need to install the package. Run the code that is commented off with the install.packages function. You should only have to do this once.
```{r}
#install.packages(c('lubridate', 'RCurl'))
library(lubridate)
library(RCurl)
```


```{r, echo=F}
# library(foreign)
# years1<-2001:2007
# ds.list1<-  vector("list", length(years1))
# years2<-2008:2015
# ds.list2<-  vector("list", length(years2))
# for(i in 1:length(years1)){
#   ds.in<-as.data.frame(read.spss(paste0('./ecuador raw/defunciones_',years1[i],'.sav')))
#   ds.list1[[i]]<-ds.in[,c('CAUSA', 'EDAD','ANOF','MESF','ANON','MESN','PROV','CANT')]
# } 
# for(i in 1:3){
#   print(i)
#   ds.in<-as.data.frame(read.spss(paste0('./ecuador raw/EDG',years2[i],'.sav')))
#   names(ds.in)<-tolower(names(ds.in))
#    ds.list2[[i]]<-ds.in[,c('causa', 'edad','aniof','mesf','anion','mesn','prov','cant')]
#       names(ds.list2[[i]])<-c('CAUSA', 'EDAD','ANOF','MESF','ANON','MESN','PROV','CANT')
# } 
# for(i in 4:7){
#   print(i)
#   ds.in<-as.data.frame(read.spss(paste0('./ecuador raw/EDG',years2[i],'.sav')))
#   names(ds.in)<-tolower(names(ds.in))
#    ds.list2[[i]]<-ds.in[,c('causa', 'edad','anio_fall','mes_fall','anio_nac','mes_nac','prov_res','cant_res')]
#    names(ds.list2[[i]])<-c('CAUSA', 'EDAD','ANOF','MESF','ANON','MESN','PROV','CANT')
# } 
# for(i in c(8)){
#   print(i)
#   ds.in<-as.data.frame(read.spss(paste0('./ecuador raw/EDG',years2[i],'.sav')))
#   names(ds.in)<-tolower(names(ds.in))
#    ds.list2[[i]]<-ds.in[,c('causa', 'edad','anio_fall','mes_fall','anio_nac','mes_nac','prov_res','cant_insc')]
#    names(ds.list2[[i]])<-c('CAUSA', 'EDAD','ANOF','MESF','ANON','MESN','PROV','CANT')
# } 
# ds.append1<-do.call('rbind.data.frame',ds.list1)
# ds.append2<-do.call('rbind.data.frame',ds.list2)
# ds.combined<-rbind.data.frame(ds.append1, ds.append2)
# ds.combined.u5 <- ds.combined[ds.combined$EDAD<5,]
# saveRDS(ds.combined.u5, './ecuador raw/u5.deaths.2001.2015.rds')
# ds1<-readRDS( './ecuador raw/u5.deaths.2001.2015.rds')
# ds1$MESF<-trimws(ds1$MESF, which='both')
# ds1$MESF[ds1$MESF %in% c('1','Enero')] <-'Jan'
# ds1$MESF[ds1$MESF %in% c('2','Febrero')] <-'Feb'
# ds1$MESF[ds1$MESF %in% c('3','Marzo')] <-'Mar'
# ds1$MESF[ds1$MESF %in% c('4','Abril')] <-'Apr'
# ds1$MESF[ds1$MESF %in% c('5','Mayo')] <-'May'
# ds1$MESF[ds1$MESF %in% c('6','Junio')] <-'Jun'
# ds1$MESF[ds1$MESF %in% c('7','Julio')] <-'Jul'
# ds1$MESF[ds1$MESF %in% c('8','Agosto')] <-'Aug'
# ds1$MESF[ds1$MESF %in% c('9','Septiembre')] <-'Sep'
# ds1$MESF[ds1$MESF %in% c('10','Octubre')] <-'Oct'
# ds1$MESF[ds1$MESF %in% c('11','Noviembre')] <-'Nov'
# ds1$MESF[ds1$MESF %in% c('12','Diciembre')] <-'Dec'
# 
# ds1$MESN<-trimws(ds1$MESN, which='both')
# ds1$MESN[ds1$MESN %in% c('1','Enero')] <-'Jan'
# ds1$MESN[ds1$MESN %in% c('2','Febrero')] <-'Feb'
# ds1$MESN[ds1$MESN %in% c('3','Marzo')] <-'Mar'
# ds1$MESN[ds1$MESN %in% c('4','Abril')] <-'Apr'
# ds1$MESN[ds1$MESN %in% c('5','Mayo')] <-'May'
# ds1$MESN[ds1$MESN %in% c('6','Junio')] <-'Jun'
# ds1$MESN[ds1$MESN %in% c('7','Julio')] <-'Jul'
# ds1$MESN[ds1$MESN %in% c('8','Agosto')] <-'Aug'
# ds1$MESN[ds1$MESN %in% c('9','Septiembre')] <-'Sep'
# ds1$MESN[ds1$MESN %in% c('10','Octubre')] <-'Oct'
# ds1$MESN[ds1$MESN %in% c('11','Noviembre')] <-'Nov'
# ds1$MESN[ds1$MESN %in% c('12','Diciembre')] <-'Dec'
# saveRDS(ds.combined.u5, './ecuador raw/u5.deaths.2001.2015.rds')

```

# Tutorial on the use of administrative data

In this tutorial, you will learn about:
  1. The types of administrative data 
  2. The minimum requirement of the data for performing a credible analysis
  3. How to extract relevant information from these databases 
  4. How to format the data into time series
  5. How to perform visual quality checks
  6. How to fit models to the data to evaluate vaccine impact
  7. How to interpret and describe the results 

This tutorial is designed for individuals without extensive experience in R, but if you want to learn about the R software, which underlies these anayses, you can learn some basics in this other tutorial: https://weinbergerlab.shinyapps.io/SurveillanceIntroR/. In this tutorial, we will format and analyze publicly-available data from Ecuador. these data for 2001-2015 were downloaded from the Instituto Nacional de Estadisticas y Censos https://www.ecuadorencifras.gob.ec/defunciones-generales-y-fetales-bases-de-datos/ 

The key variables we will work with are:
-Causa: The main cause of death ('causa basica'), with the first 3-digits of the ICD10 code
-anof: Year of death
-mesf: month of death
-anon: age in years

This dataset has all deaths for children <59 months of age.

The data are stored as an R dataset. 

First read in the data

```{r}
ds1<-readRDS( './ecuador raw/u5.deaths.2001.2015.rds')
```

Look at the first few lines
```{r}
head(ds1)
```

```{r}
birth.date<-as.Date(paste(ds1$ANON, ds1$MESN, '01', sep='-'), '%Y-%b-%d')
death.date<-as.Date(paste(ds1$ANOF, ds1$MESF, '01', sep='-'), '%Y-%b-%d')
age.check<-(death.date-birth.date)/365
plot(age.check, ds1$EDAD)
```



## Types of administrative data

"Administrative data" comprises a broad set of data sources that are routinely collected as part of healthcare delivery and colletion of vital statistics. These include electronic sources, such as hospital discharge databases, 'electronic health records', insurance databases, as well as data that are not stored electronically, such as paper log books from a health center or hospital.

###ICD coding
Many electronic administrative databases (particularly mortality data) use the International Classification of Disease (ICD) to classify causes of illness of death into specific categories. The 10th revision of the ICD (ICD10) is the most commonly used categorization, but some older data sources ue ICD8 or ICD9. 

Causes of illness or death are organized into broad categories in ICD10. These groupings of ICD codes are called *chapters*. For examples, the chapter that includes codes A00-B99 covers "certain infectious and parasitic diseases," while the chapter that includes codes J00-J99 covers "Diseases of the respiratory system." The chapters are further subdivided into sub-chapters. The J00-J99 chapter has 11 sub-chapers, which include 'Acute upper Respiratory infections' (J00-J06), 'Influenza and pneumonia' (J09-J18), and 'Chronic lower respiratory diseases' (J40-J47). The subchapters are further subdivided into specific causes, and many of these coes are further subdivided. As an example, J09-J18 has 10 codes 

### Recording of causes of illness or death
Some databases record just a single cause of illness or death while others have multiple causes listed. For example XXX. This poses a challenge when comparing between databases.

The *specificity* of coding differs by database. For instance, many of the Latin American databases commonly use J18.9 (pneumonia, unspecified organism), which is a non-specific code indicating pneumonia. In contrast, databases from the United States commonly use cause-specific codes such as J13 ("pneumonia due to *Streptococcus pneumoniae*"). This has an important effect on the analysis: if you can only use non-specific codes, then pneumococcus will comprise a relatively small fraction of all cases, and you will therefore detec a small relative decline. But if you can use more pathogen-specific codes, it will usually be easier to detect an effect of vaccine.

## Minimum requirements for a credible analysis

### Number of years

**See section below on baseline length**

### Number of cases

### xxx

## Extracting relevant information

With a database that uses ICD codes to classify causes of death, we can create case definitions based on the presence of absence of individual codes or combinations of cdes (when multiple diagnostic codes are present). In the excercise below, we will search for and flag records that have a diagnosis code indicating a respiratory condition (codes starting with 'J'), as well as codes specific for pneumonia (J12-J18). We will then look at the frequency with which the different codes are used


```{r extract1, exercise=TRUE}

#This will contain an interactive extraction of data

```

## Formatting the data into time series

```{r ts.format, exercise=TRUE}

#This will contain an interactive formatting of data

```

## Performing visual quality checks

```{r qc.plotting, exercise=TRUE}

#This will contain an interactive plotting of data

```

##Types of analysis



## Fitting models to the data to evaluate vaccine impact

```{r model.fitting, exercise=TRUE}

#This will contain an interactive plotting of data

```

## Interpreting the findings and reporting the results

# Problem situations
## What to do with a short baseline
If you have a short baseline period (ie <3 years) of pre-vaccine data, it can be difficult or impossible to disentangle trends caused by the vaccine from unrelated trends that were occurring before the vaccine was introduced. Simulation studies demonstrate that performing an interrupted time series analysis in such a situation can lead to extremely low power to detect a change. If there is a control variable that can explain any trends unrelated to the vaccine, this can be used, and the assumption would be that this control variable captures all of the important trends that could confound the results. For instance, in an analysis in The Gambia, the use of number of X-Rays performed as a control for changes in X-Ray-confirmed pneumonia effectively allowed for the estimation of a credible vaccine effect with just ~1 year of pre-vaccine data. The time series analysis needs to be adjusted from the typical setup--it is not possible to include a separate trend variable to capture pre-vaccine changes
**note to Dan: see Gambia ITS simulations on this topic** 

## How to disentangle effects of higher-valency vaccines
It is common for a country to introduce 1 vaccine (e.g., PCV7) and then switch to a higher-valency vaccine (PCV10 or PCV13). If this change occurs within a few years, it is not typically possible to disentangle the effects of the first vaccine vs the second. This is because it takes several years for a vaccine program to mature and for disease rates to reach a new equilibirum. If there is not sufficient time between the introduction of the first and second vaccine, it is not possible to disentangle these two effects. Rather, a single overall vaccine impact estimate should be presented. If there are many years between introduction of the two vaccines, than it might be possible to estimate the additional benefit of switching by comparing the trends in the period after introduction of the first vaccine but before introduction of the second vaccine with the period after introduction of the second vaccine. 
