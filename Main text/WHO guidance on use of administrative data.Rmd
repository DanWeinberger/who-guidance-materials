---
title: "WHO Manual on Administrative data"
output: 
  learnr::tutorial:
      theme: journal 
      toc: true
      toc_depth: 2
      toc_float:
        collapsed: false
        smooth_scroll: false
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
library(learnr)
library(RCurl)
library(lubridate)
#https://bookdown.org/yihui/rmarkdown/html-document.html#table-of-contents
knitr::opts_chunk$set(echo = FALSE)

url1<-getURL("https://raw.githubusercontent.com/weinbergerlab/InterventionEvaluatR/master/data-raw/PNAS/S1-Brazil.csv")
br1 <-read.csv(text=url1)
br1$date<-as.Date(br1$date)
kids<-br1[br1$age_group=='9',]

```

#Measuring the impact of new vaccines using mortality and administrative hospitalization data: Pneumococcal conjugate vaccine as a case study

## Introduction (Cris)
Once vaccines or other public health interventions are deployed, it is often desirable to measure their impact on health. This information is often critical for policy-makers who prioritize funding and implementation of different programs. However, conducting robust and credible evaluations of the public health impact of interventions is challenging. Real-world data are complex, and decisions about how to clean, format, analyze, and interpret the data can influence the conclusions about the impact of the intervention. 

In this manual, we discuss issues in performing impact analyses using routinely-collected administrative data sources. As a specific case study, we discuss challenges in evaluating the impact of the introduction of pneumococcal conjugate vaccines among children on rates of hospitalization and death due to pneumonia. 

## What is vaccine 'impact'?
Many vaccines influence disease rates in 2 ways. Direct effects reduce the risk for an individual to become ill and directly results from the immune response from the vaccine. Indirect effects are the benefit that an individual receives as a result of decreased transmission of the pathogen. Both vaccinated and unvaccinated individuals benefit from this indirect protection. When we refer to *vaccine impact* we are referring to the overall change in disease rates in the population that results from the combination of direct and indirect effects.  

## Mortality data from Vital Statistics (Cris)

##	Hospitalization data from administrative sources (Cris)


## Study design (DAN) {.tabset .tabset-fade .tabset-pills}

### Overview
Observational studies present a number of analytical challenges. The introduction of vaccines is often occurring concurrently with other oublic health and social interventions that can influence disease rates. Other relevant changes include changes in social welfare systems, changes in the capacity of the healthcare system, changes in the efficincy of registering hospitalizations and deaths, and other pharmacological interventions that could influence susceptibility (e.g., increasing use of anti-retroviral therapy in sub-Saharan Africa). Because vaccines are introduced at the same time as these other changes, it can be challenging to attribute specific changes to the introduction of a vaccine. The methods that we will discuss here attempt to address this issue using different approaches and different assumptions. It is important to be aware of the assumptions and limitations of the different approaches. 

###	Possible study designs for impact assessment

The analysis goal is to disentangle changes in disease rates that are caused by the introduction of a vaccine program with changes that are due to these other factors. There are several approaches that could be taken. First, in a *pre-licensure* study, vaccine impact could be evaluated using a cluster-randomized study design, where disease rates are compared between spatial clusters that have been randomized to receive that vaccine or not. Assuming that there is not transmission between clusters, that the assignment of clusters was random and succesful (i.e., that the vaccinated and unvaccinated clusters are comparable), this provides an unbiased estimate of the total effect of the vaccine. 

In a *post-licensure setting*, the cluster-randomized design can be approximated by using a 'step-wedge' study design. This design can be implemented in settings where the vaccine has not yet be introduced and where it might not be feasible to introduce to the entire population at the same time. With this design, geographic areas are randomized to receive the vaccine earlier or later. All geographic units eventually receive the vaccine. With this phased rollout, the geographic units that introduce the vaccine later serve as controls for the geographics units that introduce the vaccine earlier. Because the control group is changing over time and the comparisons between the vaccinated and unvaccinated groups is taking place over some time period, estimates of vaccine impact could be cofounded by underlying temporal trends. Therefore, it is important to appropriately adjust for time-varying rates of disease when analyzing these studies. 

In most settings, such controlled roll-outs of vaccine are not possible. Therefore, the most common study designs are purely observational, in which changes in disease rates are evaluated over time or between regions. Extreme caution needs to be used when performing and interpreting these studies to ensure that factors unrelated to vaccination are appropriately adjusted in the analysis. This guide will focus on the analysis situation where there is a single time series of interest from a country or region and the goal is to detect changes in incidence following vaccine introduction from this time series. When time series from multiple subnational regions are available, additional types of analyses are possible, including performing spatiotemporal analyses in which the declines in regions with higher or lower coverage are compared.  

### Counterfactuals: What would have happened without a vaccine?
With any analysis of vaccine impact, the goal is to compare the observed disease rates in the post-vaccine period with an estimate of what would have happened if the vaccine had not been introduced. This value is called the **counterfactual**. There are many ways to estimate counterfactuals from very simple approaches (as is done in pre/post comparison of incidence) to more complex approaches that adjust for trends and dynamics of the disease. In each of the followinng sections, we will discuss different methods to obtain this quantity.

##	Time series analysis
In this context, a 'time series' is defined as a variable in which the number of cases is tallied in each unit of time (week/month/quarter/year). The goal for the analysis is to detect changes in the average number of cases or incidence. In this example, we have the number of hospitalization coded as having a diagnosis for pneumonia (ICD10 codes J12-J18) in Brazil in infants

```{r, fig.wdith=7, fig.height=3}
plot(kids$date, kids$J12_18, type='l', bty='l', ylab="N hospitalizations", xlab='date', ylim=c(0, max(kids$J12_18)))
abline(v=as.Date('2010-03-01'), lty=2, col='gray')
```



####Pre-Post comparison
The simplest possible analysis approach is to compare the average number of cases or incidence in the post-vaccine period with that in the pre-vaccine period (a 'pre/post comparison' study). This method is easy to implement and easy to understand. The analyst needs to define the pre-vaccine period and the post-vaccine period. Typically, the first year or two after vaccine introducion are excluded from the analysis because vaccine coverage has not yet reached full coverage levels yet. The decision about where to set the pre- and post-vaccine periods should be made *a priori* and should not be influenced by observed aberrations in the data (unless these are due to a known data quality issue); otherwise the estimation of the variability in disease rates will not be accurate. 

```{r, fig.wdith=7, fig.height=3}
mean.pre<-mean(kids$J12_18[kids$date<as.Date('2010-03-01')])
mean.post<-mean(kids$J12_18[kids$date>=as.Date('2011-03-01')])

plot(kids$date, kids$J12_18, type='l', bty='l', ylab="N hospitalizations", xlab='date', ylim=c(0, max(kids$J12_18)))
abline(v=as.Date('2010-03-01'), lty=2, col='gray')
arrows(x0=as.Date('2003-01-01'), x1=as.Date('2010-02-01') , y0=mean.pre, length=0, col='#1b9e77')
arrows(x0=as.Date('2011-03-01'), x1=as.Date('2015-01-01') , y0=mean.post, length=0, col='#7570b3')

```

**Counterfactual** In this study design, it is assumed that if the vaccine had not been introduced, the incidence rate after vaccine introduction would be the same as the incidence of disease before vaccine introduction. Therefore the counterfactual is simply the average incidence in the pre-vaccine period, and the comparison is between incidence in the post vaccine period. In the plot below, the $\color{#d95f02}{\text{counterfactual}}$ is shown with a dotted line. Comparing the $\color{#d95f02}{\text{counterfactual}}$ with the $\color{#7570b3}{\text{observed mean for the post-period}}$ gives an estimate of the vaccine effect.

```{r, fig.width=7, fig.height=3}
mean.pre<-mean(kids$J12_18[kids$date<as.Date('2010-03-01')])
mean.post<-mean(kids$J12_18[kids$date>=as.Date('2011-03-01')])

plot(kids$date, kids$J12_18, type='l', bty='l', ylab="N hospitalizations", xlab='date', ylim=c(0, max(kids$J12_18)))
abline(v=as.Date('2010-03-01'), lty=2, col='gray')
arrows(x0=as.Date('2003-01-01'), x1=as.Date('2010-02-01') , y0=mean.pre, length=0, col='#1b9e77')
arrows(x0=as.Date('2011-03-01'), x1=as.Date('2015-01-01') , y0=mean.post, length=0, col='#7570b3')
arrows(x0=as.Date('2011-03-01'), x1=as.Date('2015-01-01') , y0=mean.pre, length=0, col='#d95f02', lty=3)

```

**Calculation of vaccine impact** The most common statistic reported from a pre/post comparison study is a Rate Ratio, which is simply calculated as (Average Incidence Post-Vaccination)/(Average Incidence Pre-Vaccination). Values <1 are considered evidence that the disease rates have declined. It is also possible to calculate a rate difference to obtain the number of cases prevented.

**Assumptions** This analysis assumes that the only change in disease rates that is occurring over time is due to the vaccine. This is rarely a realistic assumption. **Therefore, this is a weak study design, and the results should be interpreted with caution.**

**Extensions** It is sometimes desirable to adjust for seasonality in the analysis. This is particularly important when partial years are included in the pre and/or post period, and the pre- or post-periods are imbalanced in terms of which parts of the year are included in the analyses. This is accomplished in a regression model by adjusting for seasonality using dummy variables for month or harmonic variables. More details can be found in the hands-on exercises.

In this example, the $\color{#d95f02}{\text{counterfactual}}$ is seasonally adjusted, so the counterfactual for January is equal to the mean number of cases in January in the pre-vaccine period, a likewise for all of the months.

```{r}

month<-as.factor(month(kids$date))
kids$period<-0
kids$period[kids$date>=as.Date('2010-03-01')  ] <-1
kids$period[kids$date>=as.Date('2011-03-01')  ]<-2
mod1<-glm(J12_18~month+as.factor(period),family='poisson', data=kids )
pred1<-predict(mod1, type='response')
kid.counter<-kids
kid.counter$period<-as.factor(0)
pred1.counter<-predict(mod1, type='response', newdata=kid.counter)
pred1.counter[kids$date<=as.Date('2011-03-01')] <-NA

pred1.pre<-pred1
pred1.pre[kids$date>=as.Date('2010-03-01')]<-NA

pred1.post<-pred1
pred1.post[kids$date<as.Date('2011-03-01')]<-NA

plot(kids$date, kids$J12_18, type='l', bty='l', ylab="N hospitalizations", xlab='date', ylim=c(0, max(kids$J12_18)))
points(kids$date,pred1.pre, type='l' ,col='#1b9e77' )
points(kids$date,pred1.post, type='l' , col='#7570b3' )
points(kids$date,pred1.counter, type='l', col='#d95f02', lty=3  )


```


#### Interrupted time series analysis (ITS)
In many instances, there is an underlying trend in the time series that
-segmented vs spline
-Control outcomes

**Counterfactual** 
**Calculation of vaccine impact** 
**Assumptions**
***Extensions**
-Change point models
-Control covariates

#### Synthetic controls
**Counterfactual** 
**Calculation of vaccine impact** 
**Assumptions**
***Extensions**

#### Other variations
-Holt-Winter, ARIMA...
-incorporating controls into SC analyses
-Dynamic transmission models

#### Key analysis considerations
What denominator, if any?
How are denominators incorporated (as offset)
-Rollout period

**How many years of data required?**
-Requires pre-vaccine data

**What to do if you have an epidemic disease**
All of these methods assume that the disease patterns follow a preditable pattern and can be captured either using a straight line relationship (ITS), or that the relationship with control variables is stable. Therefore, these methods are generally only appropriate for **endemic** diseases. For diseases that are epidemic (e.g., meningococcal meningitis), other approaches might be required that account for the dynamics of the pathogen and the build-up of immunity in the population. If the epidemic is widespread but the intervention is limited to a smaller region, it  might be possible to use the time series from an unvaccinated control population as the control variable to generate a counterfactual in a synthetic control-type analysis. Or it might be necessary to use a dynamic transmission model that can capture non-linear dynamics (e.g., a compartmental model with Susceptiple, Infected, and Resistant classes). 

##	Defining the study question and objectives (CRISTIANA)



##	Data Sources (international and national for both mortality and hospitalization) (Cristiana)


##	Feasibility of conducting a time series analysis of secondary data to assess vaccine impact (Concepts) (CRISTIANA)


## Data management (MOSTLY CRISTIANA)


## Data analysis (text + web based tutorial) (DAN)
###	Data formatting

To evaluate changes in disease rates associated with an intervention, the first step is to format the data into a **time series**. Time series enumerate the number of cases in a time period (e.g., week, month, quarter, or year). We typically do this by starting with a spreadsheet that has individual-level data, creating a variable that has the date rounded rown to the date of the beginning of the nearest week/month/quarter/year, and then adding up the number of cases that occurred during that time period. 

Ultimately we want to get a dataset that looks something like this, with a column for the date, and a column for each of the diseases that we want to enumerate
```{r, echo=F}
dataset<-cbind.data.frame( 'date'=seq.Date(from=as.Date('2010-01-01'), length.out=15, by='month'), 'pneumonia'=rpois(15, lambda=50), 'control1'=rpois(15, lambda=200))
print(dataset)
```

If you have multiple strata, such as different age groups or regions, the dataset will need to reflect this. In the table below, we have 3 age groups, each with 5 observations. Each date/age group combination should have only 1 row in this dataset.
```{r, echo=F}
dataset<-cbind.data.frame( 'age_group'= rep(1:3, each=5), 'date'=seq.Date(from=as.Date('2010-01-01'), length.out=5, by='month'), 'pneumonia'=rpois(15, lambda=50), 'control1'=rpois(15, lambda=200))
print(dataset)
```

In the *exercise*, we will learn how to take a individual-level dataset that has 1 observation for each hospitalization/death and convert it to a time series dataset.

-	Descriptive analysis
-	Time series models
- Synthetic Control analysis
-	Incorporating co-variates into the analyses
-	Exercises
#### Converting individual-level data to time series

## Interpreting results (DAN)
	‘dummy’ results that highlight different scenarios (ie wide Cis with a point estimate <<1, wide Cis with a point estimate near 1, tight Cis with a point estimate near 1, tight Cis with a point estimate far from 1)
o	Communicating and Presenting results effectively (including suggested templates) (DAN AND CRIS)
```{r}
#https://bookdown.org/yihui/rmarkdown/layout.html#story-boards
```


